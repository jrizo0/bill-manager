import { createRequire as topLevelCreateRequire } from 'module';const require = topLevelCreateRequire(import.meta.url);import bannerUrl from 'url';const __dirname = bannerUrl.fileURLToPath(new URL('.', import.meta.url));
import S from"node:fs";import l from"node:path";import B from"node:http";var p=class extends B.IncomingMessage{constructor({method:e,url:o,headers:r,body:n,remoteAddress:s}){super({encrypted:!0,readable:!1,remoteAddress:s,address:()=>({port:443}),end:Function.prototype,destroy:Function.prototype}),typeof r["content-length"]>"u"&&(r["content-length"]=Buffer.byteLength(n).toString()),Object.assign(this,{ip:s,complete:!0,httpVersion:"1.1",httpVersionMajor:"1",httpVersionMinor:"1",method:e,headers:r,body:n,url:o}),this._read=()=>{this.push(n),this.push(null)}}};import A from"node:http";var y=`\r
\r
`,u=Symbol(),d=Symbol();function C(t){if(Buffer.isBuffer(t))return t.toString("utf8");if(typeof t=="string")return t;throw new Error(`response.write() of unexpected type: ${typeof t}`)}function g(t,e){if(Buffer.isBuffer(e)||typeof e=="string"||e instanceof Uint8Array)t[u].push(Buffer.from(e));else throw new Error(`response.write() of unexpected type: ${typeof e}`)}var c=class extends A.ServerResponse{static from(e){let o=new c(e);return o.statusCode=e.statusCode,o[d]=e.headers,o[u]=[Buffer.from(e.body)],o.end(),o}static body(e){return Buffer.concat(e[u])}static headers(e){let o=typeof e.getHeaders=="function"?e.getHeaders():e._headers;return Object.assign(o,e[d])}get headers(){return this[d]}setHeader(e,o){this._wroteHeader?this[d][e]=o:super.setHeader(e,o)}writeHead(e,o,r){let n=typeof o=="string"?r:o;for(let s in n)if(this.setHeader(s,n[s]),!this._wroteHeader)break;super.writeHead(e,o,r)}constructor({method:e}){super({method:e}),this[u]=[],this[d]={},this.useChunkedEncodingByDefault=!1,this.chunkedEncoding=!1,this._header="",this.assignSocket({_writableState:{},writable:!0,on:Function.prototype,removeListener:Function.prototype,destroy:Function.prototype,cork:Function.prototype,uncork:Function.prototype,write:(o,r,n)=>{if(typeof r=="function"&&(n=r,r=null),this._header===""||this._wroteHeader)g(this,o);else{let s=C(o),i=s.indexOf(y);if(i!==-1){let f=s.slice(i+y.length);f&&g(this,f),this._wroteHeader=!0}}typeof n=="function"&&n()}}),this.once("finish",()=>{this.emit("close")})}};import M from"next/dist/server/next-server.js";import O from"node:fs";import H from"node:path";function w(){process.env.NODE_ENV=process.env.NODE_ENV??"production"}function x(t){let e=H.join(t,"required-server-files.json"),o=O.readFileSync(e,"utf-8"),{config:r}=JSON.parse(o);return r}var F=new Set(["application/octet-stream","application/epub+zip","application/msword","application/pdf","application/rtf","application/vnd.amazon.ebook","application/vnd.ms-excel","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.openxmlformats-officedocument.wordprocessingml.document","font/otf","font/woff","font/woff2","image/bmp","image/gif","image/jpeg","image/png","image/tiff","image/vnd.microsoft.icon","image/webp","audio/3gpp","audio/aac","audio/basic","audio/mpeg","audio/ogg","audio/wavaudio/webm","audio/x-aiff","audio/x-midi","audio/x-wav","video/3gpp","video/mp2t","video/mpeg","video/ogg","video/quicktime","video/webm","video/x-msvideo","application/java-archive","application/vnd.apple.installer+xml","application/x-7z-compressed","application/x-apple-diskimage","application/x-bzip","application/x-bzip2","application/x-gzip","application/x-java-archive","application/x-rar-compressed","application/x-tar","application/x-zip","application/zip"]);function b(t){if(!t)return!1;let e=t?.split(";")[0]??"";return F.has(e)}function a(...t){}function _(t){return t.version==="2.0"}function q(t){return t.version===void 0&&!v(t)}function v(t){return t.Records!==void 0}function E(t){if(v(t))return V(t);if(_(t))return R(t);if(q(t))return N(t);throw new Error("Unsupported event type")}function P(t){if(t.type==="v2")return I(t);if(t.type==="v1")return k(t);if(t.type==="cf")return z(t);throw new Error("Unsupported event type")}function N(t){let{path:e,body:o,httpMethod:r,requestContext:n,isBase64Encoded:s}=t;return{type:"v1",method:r,rawPath:e,url:e+T(t),body:Buffer.from(o??"",s?"base64":"utf8"),headers:L(t),remoteAddress:n.identity.sourceIp}}function R(t){let{rawPath:e,rawQueryString:o,requestContext:r}=t;return{type:"v2",method:r.http.method,rawPath:e,url:e+(o?`?${o}`:""),body:D(t),headers:G(t),remoteAddress:r.http.sourceIp}}function V(t){let{method:e,uri:o,querystring:r,body:n,headers:s,clientIp:i}=t.Records[0].cf.request;return{type:"cf",method:e,rawPath:o,url:o+(r?`?${r}`:""),body:Buffer.from(n?.data??"",n?.encoding==="base64"?"base64":"utf8"),headers:J(s),remoteAddress:i}}function k(t){let e={},o={};Object.entries(t.headers).forEach(([n,s])=>{if(Array.isArray(s))o[n]=s;else{if(s===null){e[n]="";return}e[n]=s}});let r={statusCode:t.statusCode,headers:e,body:t.body,isBase64Encoded:t.isBase64Encoded,multiValueHeaders:o};return a(r),r}function I(t){let e={};Object.entries(t.headers).filter(([r])=>r.toLowerCase()!=="set-cookie").forEach(([r,n])=>{if(n===null){e[r]="";return}e[r]=Array.isArray(n)?n.join(", "):n.toString()});let o={statusCode:t.statusCode,headers:e,cookies:t.headers["set-cookie"],body:t.body,isBase64Encoded:t.isBase64Encoded};return a(o),o}function z(t){let e={};Object.entries(t.headers).filter(([r])=>r.toLowerCase()!=="content-length").forEach(([r,n])=>{e[r]=[...e[r]||[],...Array.isArray(n)?n.map(s=>({key:r,value:s})):[{key:r,value:n.toString()}]]});let o={status:t.statusCode.toString(),statusDescription:"OK",headers:e,bodyEncoding:t.isBase64Encoded?"base64":"text",body:t.body};return a(o),o}function G(t){let{headers:e,cookies:o}=t,r={};Array.isArray(o)&&(r.cookie=o.join("; "));for(let[n,s]of Object.entries(e||{}))r[n.toLowerCase()]=s;return r}function D(t){let{body:e,isBase64Encoded:o}=t;return Buffer.isBuffer(e)?e:typeof e=="string"?Buffer.from(e,o?"base64":"utf8"):typeof e=="object"?Buffer.from(JSON.stringify(e)):Buffer.from("","utf8")}function T(t){let e=new URLSearchParams;if(t.multiValueQueryStringParameters){for(let[r,n]of Object.entries(t.multiValueQueryStringParameters))if(n!==void 0)for(let s of n)e.append(r,s)}if(t.queryStringParameters)for(let[r,n]of Object.entries(t.queryStringParameters))n!==void 0&&e.append(r,n);let o=e.toString();return o?`?${o}`:""}function L(t){t.multiValueHeaders;let e={};for(let[o,r]of Object.entries(t.multiValueHeaders))r&&(e[o.toLowerCase()]=r.join(","));for(let[o,r]of Object.entries(t.headers))r&&(e[o.toLowerCase()]=r);return e}function J(t){let e={};for(let[o,r]of Object.entries(t))for(let{value:n}of r)n&&(e[o.toLowerCase()]=n);return e}w();X();var m=l.join(__dirname,".next"),U=l.join(__dirname,".open-next"),$=x(m),Q=Y(),W=Z();a({nextDir:m});var K=new M.default({hostname:"localhost",port:Number(process.env.PORT)||3e3,conf:{...$,compress:!1},customServer:!1,dev:!1,dir:__dirname}).getRequestHandler();async function Pe(t){a("event",t);let e=E(t);if(e.headers["x-forwarded-host"]&&(e.headers.host=e.headers["x-forwarded-host"]),W.files.includes(e.rawPath))return e.type==="cf"?oe(t):te();let o={method:e.method,url:e.url,headers:e.headers,body:e.body,remoteAddress:e.remoteAddress};a("IncomingMessage constructor props",o);let r=new p(o),n=new c({method:o.method});await ee(r,n);let s=n.statusCode||200,i=c.headers(n),f=b(Array.isArray(i["content-type"])?i["content-type"][0]:i["content-type"]),j=f?"base64":"utf8",h=c.body(n).toString(j);return a("ServerResponse data",{statusCode:s,headers:i,isBase64Encoded:f,body:h}),Q.includes(e.rawPath)&&i["cache-control"]&&(i["cache-control"]="public, max-age=0, s-maxage=31536000, must-revalidate"),P({type:e.type,statusCode:s,headers:i,isBase64Encoded:f,body:h})}function X(){process.chdir(__dirname)}function Y(){let t=l.join(m,"server","pages-manifest.json"),e=S.readFileSync(t,"utf-8");return Object.entries(JSON.parse(e)).filter(([o,r])=>r.endsWith(".html")).map(([o])=>o)}function Z(){let t=l.join(U,"public-files.json"),e=S.readFileSync(t,"utf-8");return JSON.parse(e)}async function ee(t,e){delete t.body;try{await K(t,e)}catch(o){console.error("NextJS request failed.",o),e.setHeader("Content-Type","application/json"),e.end(JSON.stringify({message:"Server failed to respond.",details:o},null,2))}}function te(){return{statusCode:503}}function oe(t){return t.Records[0].cf.request}export{Pe as handler};
